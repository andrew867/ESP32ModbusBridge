name: Build ESP32 Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target:
        description: 'ESP32 target chip to build for'
        required: false
        default: 'esp32'
        type: choice
        options:
          - esp32
          - esp32s2
          - esp32s3
          - esp32c3
          - esp32c6
          - esp32h2
      clean_build:
        description: 'Clean build directory before building'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.5-latest
        target: ${{ github.event.inputs.target || 'esp32' }}
        cache_dependency_path: |
          ESP32ModbusBridge/requirements.txt
          ESP32ModbusBridge/idf_component.yml

    - name: Clean build (if requested)
      working-directory: ESP32ModbusBridge
      if: ${{ github.event.inputs.clean_build == 'true' }}
      run: |
        idf.py fullclean || true
        rm -rf build || true

    - name: Set target chip
      working-directory: ESP32ModbusBridge
      run: |
        idf.py set-target ${{ github.event.inputs.target || 'esp32' }}

    - name: Build project
      working-directory: ESP32ModbusBridge
      run: |
        idf.py build

    - name: Create flashable binary
      working-directory: ESP32ModbusBridge
      run: |
        # Find the main application binary
        MAIN_BIN=$(find build -maxdepth 1 -name "*.bin" -type f ! -name "bootloader.bin" ! -name "partition-table.bin" | head -1)
        if [ -n "$MAIN_BIN" ]; then
          # Create a combined binary for easy flashing
          python $IDF_PATH/components/esptool_py/esptool/esptool.py \
            --chip ${{ github.event.inputs.target || 'esp32' }} \
            merge_bin \
            -o build/flash_image.bin \
            --flash_mode dio \
            --flash_freq 40m \
            --flash_size 4MB \
            0x1000 build/bootloader/bootloader.bin \
            0x8000 build/partition_table/partition-table.bin \
            0x10000 "$MAIN_BIN" || \
          echo "Note: merge_bin may not be available, using individual binaries"
        fi

    - name: Get build info
      working-directory: ESP32ModbusBridge
      id: build_info
      run: |
        echo "build_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "target=${{ github.event.inputs.target || 'esp32' }}" >> $GITHUB_OUTPUT
        if [ -f build/flash_image.bin ]; then
          echo "flash_size=$(stat -c%s build/flash_image.bin)" >> $GITHUB_OUTPUT
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target || 'esp32' }}-${{ steps.build_info.outputs.commit_sha }}
        path: |
          ESP32ModbusBridge/build/*.bin
          ESP32ModbusBridge/build/bootloader/bootloader.bin
          ESP32ModbusBridge/build/partition_table/partition-table.bin
        retention-days: 30

    - name: Create release package
      working-directory: ESP32ModbusBridge
      run: |
        mkdir -p release
        # Find the main application binary (ESP-IDF names it after the main component)
        MAIN_BIN=$(find build -maxdepth 1 -name "*.bin" -type f ! -name "bootloader.bin" ! -name "partition-table.bin" | head -1)
        if [ -n "$MAIN_BIN" ]; then
          cp "$MAIN_BIN" release/main.bin
        fi
        cp build/bootloader/bootloader.bin release/ 2>/dev/null || true
        cp build/partition_table/partition-table.bin release/ 2>/dev/null || true
        cp build/flash_image.bin release/ 2>/dev/null || true
        cp sdkconfig release/ 2>/dev/null || true
        
        # Copy flash scripts from repository
        cp flash.sh release/flash.sh 2>/dev/null || true
        cp flash.bat release/flash.bat 2>/dev/null || true
        chmod +x release/flash.sh 2>/dev/null || true
        
        # Create README for release using printf to avoid YAML parsing issues
        BUILD_DATE="${{ steps.build_info.outputs.build_date }}"
        COMMIT_SHA="${{ steps.build_info.outputs.commit_sha }}"
        TARGET_CHIP="${{ steps.build_info.outputs.target }}"
        {
          printf '# ESP32ModbusBridge Firmware Release\n\n'
          printf 'Build Date: %s\n' "${BUILD_DATE}"
          printf 'Commit: %s\n' "${COMMIT_SHA}"
          printf 'Target: %s\n\n' "${TARGET_CHIP}"
          printf '## Files\n\n'
          printf '- `main.bin` - Main application binary\n'
          printf '- `bootloader.bin` - Bootloader binary\n'
          printf '- `partition-table.bin` - Partition table\n'
          printf '- `flash_image.bin` - Combined flashable image (if available)\n'
          printf '- `flash.sh` - Linux/Mac flash script\n'
          printf '- `flash.bat` - Windows flash script\n\n'
          printf '## Flashing Instructions\n\n'
          printf '### Linux/Mac\n'
          printf '```bash\n'
          printf './flash.sh /dev/ttyUSB0\n'
          printf '```\n\n'
          printf '### Windows\n'
          printf '```cmd\n'
          printf 'flash.bat COM3\n'
          printf '```\n\n'
          printf '### Manual (using esptool.py)\n'
          printf '```bash\n'
          printf 'esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 \\\n'
          printf '  write_flash -z --flash_mode dio --flash_freq 40m --flash_size 4MB \\\n'
          printf '  0x1000 bootloader.bin \\\n'
          printf '  0x8000 partition-table.bin \\\n'
          printf '  0x10000 main.bin\n'
          printf '```\n\n'
          printf '## Using ESP-IDF Tools\n\n'
          printf 'If you have ESP-IDF installed:\n'
          printf '```bash\n'
          printf 'cd ESP32ModbusBridge\n'
          printf 'idf.py -p /dev/ttyUSB0 flash monitor\n'
          printf '```\n'
        } > release/README.md

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: release-package-${{ github.event.inputs.target || 'esp32' }}-${{ steps.build_info.outputs.commit_sha }}
        path: ESP32ModbusBridge/release/*
        retention-days: 30

    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Target:** ${{ github.event.inputs.target || 'esp32' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** ${{ steps.build_info.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ steps.build_info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Build successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Download the firmware binaries from the artifacts section above." >> $GITHUB_STEP_SUMMARY

